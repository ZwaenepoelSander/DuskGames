/*
Copyright (c) 2024 Dusk
All rights reserved.

This code is proprietary to Dusk AI Inc.
The code may be used solely for accessing the Service provided by Dusk AI Inc. following the Dusk Terms of Service ("Terms") accessible at dusk.gg/eula. You may not use this code for any use or purpose other than as expressly permitted by the Terms.
Restrictions set forth in the Terms include, but is not limited to, that you may not copy, adapt, modify, prepare derivative works based upon, distribute, license, sell, transfer, publicly display, publicly perform, transmit, stream, broadcast, attempt to discover any source code, reverse engineer, decompile, dissemble, or otherwise exploit the code as a whole or any portion of the code.
*/
"use strict";var e=require("compatto"),r=require("rune-msgpack"),t=require("base-64"),n=require("mutative");function o(e){var r=Object.create(null);return e&&Object.keys(e).forEach((function(t){if("default"!==t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})}})),r.default=e,Object.freeze(r)}var a=o(r),i=o(t);function s(e){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s(e)}function c(e){return function(e){if(Array.isArray(e))return u(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,r){if(!e)return;if("string"==typeof e)return u(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);"Object"===t&&e.constructor&&(t=e.constructor.name);if("Map"===t||"Set"===t)return Array.from(e);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return u(e,r)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=new Array(r);t<r;t++)n[t]=e[t];return n}var l=function(){return l=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var o in r=arguments[t])Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e},l.apply(this,arguments)};function d(e,r){var t={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&r.indexOf(n)<0&&(t[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)r.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(t[n[o]]=e[n[o]])}return t}function f(e,r,t,n){return new(t||(t=Promise))((function(o,a){function i(e){try{c(n.next(e))}catch(e){a(e)}}function s(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(i,s)}c((n=n.apply(e,r||[])).next())}))}function v(e,r){var t,n,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(s){return function(c){return function(s){if(t)throw new TypeError("Generator is already executing.");for(;a&&(a=0,s[0]&&(i=0)),i;)try{if(t=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,n=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){i.label=s[1];break}if(6===s[0]&&i.label<o[1]){i.label=o[1],o=s;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(s);break}o[2]&&i.ops.pop(),i.trys.pop();continue}s=r.call(e,i)}catch(e){s=[6,e],n=0}finally{t=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}}function p(e){var r="function"==typeof Symbol&&Symbol.iterator,t=r&&e[r],n=0;if(t)return t.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")}function m(e,r){var t="function"==typeof Symbol&&e[Symbol.iterator];if(!t)return e;var n,o,a=t.call(e),i=[];try{for(;(void 0===r||r-- >0)&&!(n=a.next()).done;)i.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(t=a.return)&&t.call(a)}finally{if(o)throw o.error}}return i}function g(e,r,t){if(t||2===arguments.length)for(var n,o=0,a=r.length;o<a;o++)!n&&o in r||(n||(n=Array.prototype.slice.call(r,0,o)),n[o]=r[o]);return e.concat(n||Array.prototype.slice.call(r))}function E(e){var r,t,n={};try{for(var o=p(Object.values(e)),a=o.next();!a.done;a=o.next()){var i=a.value;i.playerId&&(n[i.playerId]={playerId:i.playerId,displayName:i.displayName,avatarUrl:i.avatarUrl})}}catch(e){r={error:e}}finally{try{a&&!a.done&&(t=o.return)&&t.call(o)}finally{if(r)throw r.error}}return n}var y="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",S=y.length;function T(e,r){if(!e)throw r instanceof Error?r:new Error(null!=r?r:"Assertion failed")}function _(e){if("object"!=typeof e||null===e)return!1;var r=Object.getPrototypeOf(e);return!(null!==r&&r!==Object.prototype&&null!==Object.getPrototypeOf(r)||Symbol.toStringTag in e||Symbol.iterator in e)}function I(e,r,t){return void 0===t&&(t=""),function(e){for(var r=0,t=1779033703^e.length;r<e.length;r++)t=(t=Math.imul(t^e.charCodeAt(r),3432918353))<<13|t>>>19;return t=Math.imul(t^t>>>16,2246822507),t=Math.imul(t^t>>>13,3266489909),(t^=t>>>16)>>>0}("".concat(t?t+"-":"").concat(e,"-").concat(r))}function h(e,r){return Math.floor(e/r)}function O(e,r){return e*r}function A(){return Math.floor(performance.now())}function b(e,r,t){return t*r-e}function P(e){return 2*e.length<1048576}function M(e){return e.sort((function(e,r){return e>r?1:-1}))}function D(e,r){var t=(JSON.stringify(e)||"").length;return{size:t,underLimit:t<1024*r}}var R={},N={devUIUnexpected:!0};function C(e){return"Encountered ".concat(e,", which should never happen. Please let us know on [Discord](https://discord.gg/dusk-devs)")}function G(e){return"[GAMES_SDK][".concat(e,"]")}var L={ACTION_TRIGGERED_INVALID_ACTION:{devUIMessage:function(e){return'Action "'.concat(e.action,'" threw ').concat("Dusk",".invalidAction() in the server. This action will be ignored.")}},GAME_TO_SERVER_MSG_SIZE:R,GAME_TO_SERVER_MSG:R,PLAYER_LEFT_AFTER_GAME_OVER:R,WRONG_TICK_CLIENT_AHEAD:R,WRONG_TICK_SERVER_SLOW:R,WRONG_TICK_MSG_ARRIVED_LATE:R,WRONG_TICK_UNEXPECTED_REASON:R,SERVER_TO_GAME_BROADCAST_MSG:R,SERVER_TO_GAME_MSG_SIZE:R,SERVER_TO_GAME_SEND_MSG:R},w={errorMap:{GAME_OVER_INVALID_OPTIONS:{devUIMessage:"Your game called ".concat("Dusk",".gameOver() with invalid options. See console for more details and [game over docs](https://developers.dusk.gg/docs/api-reference#duskgameoveroptions) for examples."),consoleMessage:function(e){return"Game over was called with invalid options:\n".concat(JSON.stringify(e.gameOverOptions,null,2),".")},printExtraDataInDevUI:!0},STATE_SYNC_TOO_BIG:{devUIMessage:function(e){return"Your game state is too big (".concat(e.messageSize/1024,"kb). Maximum is ").concat(e.limit/1024," kb. See [game restrictions](https://developers.dusk.gg/docs/how-it-works/syncing-game-state#restrictions) for more info.")}},SERVER_UPDATE_LOOP_FAILED:{devUIMessage:"Your `update` function failed on the server. See the console for more details.",printExtraDataInDevUI:!0},ACTION_FAILED:{devUIMessage:function(e){return'Action "'.concat(e.action,'" failed on the server. See console for more details.')},printExtraDataInDevUI:!0},PLAYER_JOINED_FAILED:{devUIMessage:"Your `playerJoined` function failed on the server. See the console for more details.",printExtraDataInDevUI:!0},PLAYER_LEFT_FAILED:{devUIMessage:"Your `playerLeft` function failed on the server. See the console for more details.",printExtraDataInDevUI:!0},UPDATE_LOOP_BEHIND_GAME_TIME:N,SERVER_UPDATE_LOOP_FASTER_THAN_GAME_TIME:N,GET_GAME_STATE_FAILED:N,SERVER_RECEIVED_MESSAGE_TOO_BIG:N,SERVER_MESSAGE_TO_CLIENTS_TOO_BIG:N,SERVER_FULL:N,ON_PLAYER_JOINED_CALLBACK_MISSING:N,ROOM_GAME_STATE_MISSING:N,ACTION_PARAMS_SIZE_OVER_LIMIT:N,SETUP_PERSISTED_KEY_NOT_ALLOWED:{devUIMessage:'Setup function can\'t return "persisted" key. If you wish to modify persisted state, modify game.persisted instead.'},PERSISTED_NOT_AN_OBJECT:{devUIMessage:"game.persisted value must be set to an object."},PERSISTED_KEY_MISSING:{devUIMessage:"Removing game.persisted key is not allowed."},PERSISTED_EXTRA_KEY_DETECTED:{devUIMessage:function(e){return'Extra key "'.concat(e.key,'" in game.persisted detected. Only currently playing player ids as keys are allowed.')}},PERSISTED_PLAYER_MISSING:{devUIMessage:function(e){return"game.persisted is missing player ".concat(e.playerId," state. Make sure to return all players.")}},PERSISTED_PLAYER_NOT_AN_OBJECT:{devUIMessage:function(e){return'game.persisted["'.concat(e.playerId,'"] must be an object.')}},PERSISTED_PLAYER_OVER_LIMIT:{devUIMessage:function(e){return'game.persisted["'.concat(e.playerId,'"] size is ').concat(e.size,"kb which is over allowed limit of ").concat(e.limit,"kb.")}},SETUP_GAME_OVER_NOT_ALLOWED:{devUIMessage:"".concat("Dusk",".gameOver() is not allowed in setup function")},PERSISTED_STATE_NOT_ENABLED:N,PERSISTED_STATE_USED_WITHOUT_FLAG:{devUIMessage:"To use game.persisted, you must set persistPlayerData: true inside ".concat("Dusk",".initLogic().")},SETUP_FAILED:{devUIMessage:"Setup function failed",printExtraDataInDevUI:!0},PERSIST_DATA_AFTER_ERROR_NOT_AVAILABLE:N,GET_PERSISTED_STATE_FAILED:N,GAME_END_PERSIST_USER_NOT_FOUND:N,PLAYER_LEFT_NO_USERS_INCORRECT_PERSISTED_PLAYERS:N},infoMap:L,warningMap:{GAME_SESSION_ID_MISMATCH:N,CLIENT_MESSAGE_DECODE_FAILED:N,ACTION_PLAYER_ID_AUTHENTICATION_MISMATCH:N,ACTION_NO_SEED_OR_ACTION_COUNT:N,ACTION_WRONG_SEED:R,ACTION_COUNT_MISMATCH:R,ACTION_AFTER_GAME_OVER:R}};function x(e){return function(e,r){function t(e,r,t,n){n?e[r](n,t):e[r](t)}function n(r,n,o,a,i){var s=o[a],c=G(a);if("test"!==e&&"runtime"!==e)if(s)if("devUIUnexpected"in s)t(n,r,C(a));else{var u="consoleMessage"in s?s.consoleMessage:s.devUIMessage;u&&(t(n,r,"string"==typeof u?u:u(i)),s.printExtraDataInDevUI&&i&&(i.err?console[r](i.err):console[r](i)))}else t(n,r,C(a),i);else t(n,r,c,i)}return{warn:function(e,t,o){n("warn",e,r.warningMap,t,o)},error:function(e,t,o){n("error",e,r.errorMap,t,o)},info:function(e,t,o){n("info",e,r.infoMap,t,o)},getDevUIErrorMessage:function(e,t){var n=e.replace("[GAMES_SDK][","").replace("]",""),o=r.errorMap[n],a=G(n);return o?"devUIUnexpected"in o?C(n):o.devUIMessage?"string"==typeof o.devUIMessage?o.devUIMessage:o.devUIMessage(t):C(G("UNHANDLED_DEV_UI_SCENARIO")):a},getDevUIErrorTitle:function(e){var t=e.replace("[GAMES_SDK][","").replace("]",""),n=r.errorMap[t];if(n)return"devUIErrorTitle"in n?n.devUIErrorTitle:void 0}}}(e,w)}var k,U=["stateHash","orderNumber","serverGameTime","updateCount","logicTick","action","playerId","params","uuid","actionCount","sessionId","randomSeed","measureLatencyStart","expectedLogicTick"],j=function(e){var r;return(null!==(r=null==e?void 0:e.sdkProtocolVersion)&&void 0!==r?r:2)>=3};!function(e){e.GameToServer="G",e.ServerToGame="S"}(k||(k={}));var V=function(e){for(var r=[],t=0,n=e.length;t<n;t++)r.push(String.fromCharCode(e[t]));return r.join("")},H=function(e){return i.encode(e)},F=function(e){return e.charCodeAt(0)},Y=function(e){return Uint8Array.from(e,F)},K=function(e){return i.decode(e)};function B(e){var r=m(e.split(";"),2),t=r[0],n=r[1];if(t&&n){var o=m(t.split(","),4),a=o[0],i=o[1],s=o[2],c=o[3];if(!a||!i||!c)throw new Error("Missing fields: "+a+","+i+","+c+" - "+t+" - "+e);var u=Number.parseInt(a),l=Number.parseInt(i);if(Number.isNaN(u))throw new Error("Invalid version number provided in game message: ".concat(u));if(Number.isNaN(l))throw new Error("Invalid game ID provided in game message: ".concat(l));if(!Object.values(k).includes(c))throw new Error("Invalid message type provided in game message: ".concat(c));return{version:u,gameId:l,sessionId:0===s.length?void 0:s,type:c}}}var W=function(){function r(r,t,n,o,a){this.compatto=e.compatto({dictionary:[]}),this.compatto=e.compatto({dictionary:n}),this.gameId=r,this.expectedSessionId=t,this.logger=o,this.sdkProtocolVersion=a}return r.prototype.encodeServerToGame=function(e,r){return void 0===r&&(r=!1),this.encodeHeader(k.ServerToGame)+";"+this.encodeBody(e,r)},r.prototype.encodeGameToServer=function(e,r){return void 0===r&&(r=!1),this.encodeHeader(k.GameToServer)+";"+this.encodeBody(e,r)},r.prototype.encodeBody=function(e,r){var t=a.encode(e,{maxDepth:25});return this.sdkProtocolVersion>=4&&this.compatto&&r?"_"+H(V(this.compatto.compress(V(t)))):H(V(t))},r.prototype.decodeGameToServer=function(e,r){if("string"==typeof e){var t=B(e);if(t&&t.type===k.GameToServer)return this.decodeBody(t,e,r)}},r.prototype.decodeServerToGame=function(e,r){if("string"==typeof e){var t=B(e);if(t&&t.type===k.ServerToGame)return this.decodeBody(t,e,r)}},r.prototype.extractBody=function(e){var r=m(e.split(";"),2);return r[0],r[1]},r.prototype.decodeBody=function(e,r,t){var n,o=this.extractBody(r),i=o.startsWith("_");if(i){if(e.sessionId!==this.expectedSessionId)return void this.logger.onSessionMismatch(null!==(n=e.sessionId)&&void 0!==n?n:null,this.expectedSessionId,t);o=o.substring(1)}var s=Y(K(o));return i&&(s=Y(this.compatto.decompress(s))),a.decode(s)},r.prototype.encodeHeader=function(e){var r;return this.sdkProtocolVersion+","+this.gameId+","+(null!==(r=this.expectedSessionId)&&void 0!==r?r:"")+","+e},r}();function J(e){var r=a.encode(e,{maxDepth:25});return"RUNE_MSG_V2;"+H(V(r))}var z=new(function(){function e(){this.lastDecodedValue="",this.lastDecodedMessage=void 0}return e.prototype.isClientMessage=function(e){if(!this.isRuneMsg(e))return!1;var r=this.decode(e);return r.runeGameEvent||r.runeGameCommand},e.prototype.decodeGameToClient=function(e){if(this.isRuneMsg(e))return this.decode(e).runeGameEvent},e.prototype.decodeClientToGame=function(e){if(this.isRuneMsg(e))return this.decode(e).runeGameCommand},e.prototype.decodeGameToServer=function(e){if(this.isRuneMsg(e))return this.decode(e).gameToServer},e.prototype.decodeServerToGame=function(e){if(this.isRuneMsg(e))return this.decode(e).serverToGame},e.prototype.isRuneMsg=function(e){return"string"==typeof e&&e.startsWith("RUNE_MSG_V2;")},e.prototype.decode=function(e){return e===this.lastDecodedValue||(this.lastDecodedValue=e,this.lastDecodedMessage=function(e){var r=Y(K(e.slice("RUNE_MSG_V2;".length)));return a.decode(r)}(e)),this.lastDecodedMessage},e.prototype.encodeClientToGame=function(e){return J({runeGameCommand:e})},e.prototype.encodeGameToClient=function(e){return J({runeGameEvent:e})},e.prototype.encodeGameToServer=function(e){return J({gameToServer:e})},e.prototype.encodeServerToGame=function(e){return J({serverToGame:e})},e}());function q(e){var r=e.sdkProtocolVersion,t=e.gameId,n=e.sessionId,o=e.dictionary,a=e.logger;return r>2?new W(t,n,o,a,r):z}function Z(e,r){var t=new Error("[GAMES_SDK][".concat(e,"]"));return r&&(t.extraLoggingData=r),t}function X(e,r,t){var n;return e&&"error"in e?"ROOM_GAME_STATE_MISSING":"string"!=typeof r&&(null===(n=null==r?void 0:r.message)||void 0===n?void 0:n.startsWith("[GAMES_SDK]"))?null==r?void 0:r.message.match(/\[GAMES_SDK]\[(.*)]/)[1]:t}function Q(e,r,t,n){if(!e)return null;var o=r.getUsers(),a={};return Object.keys(e).forEach((function(r){var i=Object.values(o).find((function(e){return e.playerId===r}));i?a[i.userId]=e[r]:t.error(n,"GAME_END_PERSIST_USER_NOT_FOUND",{playerId:r})})),a}var $=function e(r){var t=r,n={}.toString.call(r).slice(8,-1);if("Set"==n)return new Set(c(r).map((function(r){return e(r)})));if("Map"==n)return new Map(c(r).map((function(r){return[e(r[0]),e(r[1])]})));if("Date"==n)return new Date(r.getTime());if("RegExp"==n)return RegExp(r.source,function(e){if("string"==typeof e.source.flags)return e.source.flags;var r=[];return e.global&&r.push("g"),e.ignoreCase&&r.push("i"),e.multiline&&r.push("m"),e.sticky&&r.push("y"),e.unicode&&r.push("u"),r.join("")}(r));if("Array"==n||"Object"==n)for(var o in t=Array.isArray(r)?[]:{},r)t[o]=e(r[o]);return t};var ee="".concat("DUSK","_INVALID_ACTION");var re=["acos","acosh","asin","asinh","atan","atan2","atanh","cbrt","cos","cosh","exp","expm1","hypot","log","log10","log1p","log2","pow","sin","sinh","sqrt","tan"];var te=new Map;function ne(e){var r=te.get(e);if(!r)throw new Error("[GAMES_SDK][ROOM_GAME_STATE_MISSING]");return r}function oe(e,r){te.set(e,r)}function ae(e){te.delete(e)}var ie={};Object.defineProperty(ie,"__esModule",{value:!0});var se=ie.default=function e(r){if("object"!==s(r)||null===r)return r;if(Array.isArray(r))return r.map((function(r){return"object"!==s(r)||null===r?r:e(r)}));var t={};for(var n in r){var o=r[n];t[n]="object"!==s(o)||null===o?o:e(o)}return t};function ce(e,r,t){if(!t){var o=se(e);return r(o),o}return n.create(e,r,{mark:function(){return"immutable"}})}function ue(e){for(var r=fe(this,e),t=0;t<this.length;t++)this[t]=r[t];return this}var le=function(e,r){if(void 0===e&&void 0===r)return 0;if(void 0===e)return 1;if(void 0===r)return-1;var t=de(e),n=de(r);return t<n?-1:t>n?1:0},de=function(e){if(null===e)return"null";if("boolean"==typeof e||"number"==typeof e)return e.toString();if("string"==typeof e)return e;if("symbol"==typeof e)throw new TypeError;return e.toString()};function fe(e,r){if(void 0===r&&(r=le),e.length<=1)return e;var t=Math.floor(e.length/2),n=e.slice(0,t),o=e.slice(t);return function(e,r,t){var n=[];for(;e.length&&r.length;)t(e[0],r[0])<=0?n.push(e.shift()):n.push(r.shift());return n.concat(e,r)}(fe(n,r),fe(o,r),r)}function ve(e,r){var t,n=globalThis.Math.random;globalThis.Math.random=(t=e,function(){var e=t+=1831565813;return e=Math.imul(e^e>>>15,1|e),(((e^=e+Math.imul(e^e>>>7,61|e))^e>>>14)>>>0)/4294967296});var o=globalThis.Array.prototype.sort;globalThis.Array.prototype.sort=ue;try{return r()}finally{globalThis.Math.random=n,globalThis.Array.prototype.sort=o}}function pe(e){for(var r,t,n,o=(r=e,void 0===(t={sortKeys:!0})&&(t={}),a.encode(r,{maxDepth:25,sortKeys:null!==(n=t.sortKeys)&&void 0!==n&&n})),i=0,s=0;s<o.length;s++)i+=o[s];return i}function me(e){return"object"==typeof e&&!Array.isArray(e)&&null!==e}function ge(e,r){if(!e.persisted)throw Z("PERSISTED_KEY_MISSING");if(!me(e.persisted))throw Z("PERSISTED_NOT_AN_OBJECT");r.forEach((function(r){if(!e.persisted[r])throw Z("PERSISTED_PLAYER_MISSING",{playerId:r});if(!me(e.persisted[r]))throw Z("PERSISTED_PLAYER_NOT_AN_OBJECT",{playerId:r});var t=D(e.persisted[r],100);if(!t.underLimit)throw Z("PERSISTED_PLAYER_OVER_LIMIT",{playerId:r,limit:100,size:t.size})})),Object.keys(e.persisted).forEach((function(e){if(!r.includes(e))throw Z("PERSISTED_EXTRA_KEY_DETECTED",{key:e})}))}exports.canSwitchSpectatorToPlayer=function(e,r){return Object.keys(E(e)).length<r.maxPlayers},exports.createGameServer=function(e){var r,t=e.initialMsgLogger,n=e.params,o=n.gameId,a=n.roomId,i=n.sessionId,s=n.initialServerData,c=n.serverSeed,u=n.persistedUsers,y=e.flags,S=y.sendStateHash,R=void 0===S||S,N=y.logWrongTick,C=void 0!==N&&N,G=y.logNetworkMsg,L=void 0!==G&&G,w=y.logNetworkMsgSize,k=void 0!==w&&w,V=y.sendInitialStateSync,H=void 0!==V&&V,F=y.isPersistFeatureEnabled,Y=void 0!==F&&F,K=e.config,B=K.logicTimeoutDuration,W=void 0===B?100:B,J=K.allowedGameTimeDelay,z=void 0===J?5e3:J,Z=K.gameTimeUpdateEveryXTicks,$=void 0===Z?5:Z,ee=K.environment,re=void 0===ee?"runtime":ee,te=K.sdkProtocolVersion,ne=e.network,oe=e.logic;return f(this,void 0,void 0,(function(){function e(e,r,t){return f(this,void 0,void 0,(function(){var o,a,i,s;return v(this,(function(c){switch(c.label){case 0:return ve=!0,"err"!==t?[3,1]:(o=-1,a={},[3,3]);case 1:return[4,S(e,!!ne.onTimelineEntry)];case 2:i=c.sent(),o="error"in i?-1:i.data.stateHash,a="error"in i?{}:i.data.gameState,c.label=3;case 3:return ne.onTimelineEntry&&(s=JSON.stringify(a),n(e,{type:"END",stateHash:o,gameState:s.length>5e3?s.slice(0,5e3):a,logicTick:r,reason:t})),ge?[2,a.persisted]:[2,null]}}))}))}function n(e,r){ne.onTimelineEntry&&(ne.onTimelineEntry(e,l(l({},r),{order:le})),le++)}function y(r,t,n){var o;return f(this,void 0,void 0,(function(){var a,i,s;return v(this,(function(c){switch(c.label){case 0:if(ve)return[2,!0];if("gameEnded"!==(null==n?void 0:n.reason)||void 0===n.options)return[3,5];c.label=1;case 1:return c.trys.push([1,2,,5]),function(e,r){var t,n;if(void 0!==e){if(T("object"==typeof e&&null!==e&&_(e),"must be an object"),T("players"in e||"everyone"in e,"must have players or everyone property"),T(!("players"in e&&"everyone"in e),"players and everyone option are not allowed at the same time"),"players"in e){T("object"==typeof e.players&&null!==e.players&&_(e.players),"players must be an object"),T(Object.keys(e.players).length>0,"players must not be empty"),T(Object.keys(e.players).sort().toString()===r.sort().toString(),"all game players must be mentioned in the players object");var o=Object.values(e.players),a=0;try{for(var i=p(o),s=i.next();!s.done;s=i.next()){var c=s.value;T("number"==typeof c&&!isNaN(c)&&Number.isInteger(c)&&c>=0||["WON","LOST","TIE"].includes(c),"only number >= 0, WON, LOST, TIE are allowed as player results"),"TIE"===c&&a++}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}T(1!=a,"There must be no TIE or at least 2 TIEs in the game."),T(o.every((function(e){return["WON","LOST","TIE"].includes(e)}))||o.every((function(e){return"number"==typeof e})),"all players must have either WON, LOST, TIE or all players must have a score")}else T("number"==typeof e.everyone&&!isNaN(e.everyone)&&Number.isInteger(e.everyone)&&e.everyone>=0||["WON","LOST","TIE"].includes(e.everyone),"only number >= 0, WON, LOST, TIE are allowed as everyone value"),"TIE"===e.everyone&&T(r.length>1,"There must be at least 2 players in the game to have a TIE");"delayPopup"in e&&T("boolean"==typeof e.delayPopup,"delayPopup must be a boolean"),"minimizePopUp"in e&&T("boolean"==typeof e.minimizePopUp,"minimizePopUp must be a boolean")}}(n.options,Object.values(E(ne.getUsers())).map((function(e){return e.playerId}))),[3,5];case 2:return(a=c.sent())instanceof Error?[4,J(r,t,"GAME_OVER_INVALID_OPTIONS",a,{gameOverOptions:n.options})]:[3,4];case 3:return c.sent(),[2,!1];case 4:return[3,5];case 5:return n.players=E(ne.getUsers()),Oe.context.gameOver=n,[4,e(r,t,n.reason)];case 6:return i=c.sent(),s=Q(i,ne,_e,r),null===(o=ne.onGameOver)||void 0===o||o.call(ne,r,n.reason,s),[2,!0]}}))}))}function S(e,r){var t;return void 0===r&&(r=!1),f(this,void 0,void 0,(function(){var n;return v(this,(function(o){switch(o.label){case 0:return"err"===(null===(t=Oe.context.gameOver)||void 0===t?void 0:t.reason)?[2,{error:"[GAMES_SDK][GAME_OVER_ERR]"}]:[4,oe.getGameState(e,a,r)];case 1:return"error"in(n=o.sent())?[4,J(e,Z(F()),"GET_GAME_STATE_FAILED",void 0,{reason:n.error})]:[3,3];case 2:o.sent(),o.label=3;case 3:return[2,n]}}))}))}function N(e,r){var t;return f(this,void 0,void 0,(function(){var n;return v(this,(function(o){switch(o.label){case 0:return"err"===(null===(t=Oe.context.gameOver)||void 0===t?void 0:t.reason)?[2,{error:"[GAMES_SDK][PERSIST_DATA_AFTER_ERROR_NOT_AVAILABLE]"}]:[4,oe.getPersistedData(e,a,r)];case 1:return"error"in(n=o.sent())?[4,J(e,Z(F()),"GET_PERSISTED_STATE_FAILED",void 0,{reason:n.error})]:[3,3];case 2:return o.sent(),[2,n];case 3:return[2,n.data.persistedPlayers]}}))}))}function G(e,r,t){void 0===t&&(t=!1),Object.values(ne.getUsers()).forEach((function(n){K(e,r,n.userId,t)}))}function w(e,r){var t,n,o=!("event"in r),a=Me.encodeServerToGame(r,!1),i=De.encodeServerToGame(r,o);if(!P(i))return J(e,Z(F()),"SERVER_MESSAGE_TO_CLIENTS_TOO_BIG",void 0,{messageSize:2*i.length,limit:1048576});if(L&&_e.info(e,"SERVER_TO_GAME_BROADCAST_MSG",{serverToGameMsg:r}),k){var s="event"in r?r.event:"serverToGameAction";_e.info(e,"SERVER_TO_GAME_MSG_SIZE",{event:s,messageLength:i.length})}de=0;try{for(var c=p(Object.values(ne.getUsers())),u=c.next();!u.done;u=c.next()){var l=u.value;j(l)?ne.sendMsg(e,l.userId,i):ne.sendMsg(e,l.userId,a)}}catch(e){t={error:e}}finally{try{u&&!u.done&&(n=c.return)&&n.call(c)}finally{if(t)throw t.error}}}function V(e){return e in Oe.random||(Oe.random[e]={seed:se(e),actionCount:0}),Oe.random[e]}function F(){return xe+A()-ke}function K(e,r,t,n,o){void 0===n&&(n=!1),void 0===o&&(o=void 0);var a=ne.getUsers(),i=a[t],s=(null==i?void 0:i.playerId)?V(i.playerId):void 0,u=F(),l=Z(u),d={event:"stateSync",params:{game:r,players:E(a),pastPlayerIds:Se,gameContext:Oe.context,yourPlayerId:null==i?void 0:i.playerId,yourPlayerSeed:null==s?void 0:s.seed,yourPlayerActionCount:null==s?void 0:s.actionCount,serverSeed:c,triggeredByUpdateLoop:n,measureLatencyStart:o},orderNumber:Oe.context.orderNumber,serverGameTime:u,logicTick:l};d.dictionary=be;var f=(j(i)?De:Me).encodeServerToGame(d,!1);if(!P(f))return J(e,l,"STATE_SYNC_TOO_BIG",void 0,{msgSize:2*f.length,limit:1048576});L&&_e.info(e,"SERVER_TO_GAME_SEND_MSG",{serverToGameMsg:d}),_e.info(e,"SERVER_TO_GAME_MSG_SIZE",{event:d.event,messageLength:f.length}),ne.sendMsg(e,t,f)}function B(e){return!1===W?e:function(e,r){return new Promise((function(t,n){var o=setTimeout((function(){n(new Error("Timed out after ".concat(r,"ms.")))}),r);e.then(t,n).finally((function(){return clearTimeout(o)}))}))}(e,W)}function J(e,r,t,n,o){return f(this,void 0,void 0,(function(){var a;return v(this,(function(i){switch(i.label){case 0:return[4,y(e,r,{reason:"err",err:"runtime"!==re?{message:t,data:o?l({err:n},o):n}:void 0,players:E(ne.getUsers())})];case 1:return i.sent(),_e.error(e,t,o?l({err:n},o):n),a={},Object.values(ne.getUsers()).forEach((function(r){K(e,a,r.userId)})),[2]}}))}))}function Z(e){return me.update?Oe.updateCount:h(e,Te)}function ee(e,r,t){return f(this,void 0,void 0,(function(){var o,i,s,c,u,f,p,m,g,T,_,h,O;return v(this,(function(v){switch(v.label){case 0:return(o=ne.getUsers()[r])?(i=o.playerId)!==t.playerId?(_e.warn(e,"ACTION_PLAYER_ID_AUTHENTICATION_MISMATCH",{networkPlayerId:i,actionPlayerId:t.playerId}),[2]):Oe.context.gameOver?(_e.warn(e,"ACTION_AFTER_GAME_OVER",{action:t.action}),[2]):((s=V(i)).actionCount++,t.actionCount!=s.actionCount&&_e.warn(e,"ACTION_COUNT_MISMATCH",{networkActionCount:t.actionCount,randomStateActionCount:s.actionCount}),I(s.seed,t.actionCount)===t.randomSeed?[3,3]:[4,S(e)]):[2];case 1:return"error"in(c=v.sent())?[2]:[4,K(e,c.data.gameState,r)];case 2:return v.sent(),_e.warn(e,"ACTION_WRONG_SEED"),[2];case 3:u=F(),f=Z(u),p=void 0,v.label=4;case 4:return v.trys.push([4,6,,7]),[4,B(oe.runAction(e,t.action,{roomId:a,logicContext:{randomSeed:t.randomSeed,msPerTick:Te,logicTick:f},params:t.params,actionContext:{playerId:i,allPlayerIds:M(Object.keys(E(ne.getUsers())))},calculateStateHash:pe}))];case 5:return p=v.sent(),[3,7];case 6:return g=v.sent(),m=g,[3,7];case 7:return T=!(!p||!("data"in p)||!1===p.data)&&p.data,n(e,l({type:"ACTION",action:t.action,params:t.params,playerId:t.playerId,randomSeed:t.randomSeed,logicTick:f},T?{success:!0,stateHash:T.stateHash}:{success:!1})),T?[3,11]:p&&"data"in p?(_e.info(e,"ACTION_TRIGGERED_INVALID_ACTION",{action:t.action}),[3,10]):[3,8];case 8:return[4,J(e,f,X(p,m,"ACTION_FAILED"),m,l(l({},(null==m?void 0:m.extraLoggingData)||{}),{action:t.action}))];case 9:v.sent(),v.label=10;case 10:return[2];case 11:return"action ".concat(t.action),(_=T.gameContext.gameOver)?[4,y(e,f,T.gameContext.gameOver)]:[3,13];case 12:_=!v.sent(),v.label=13;case 13:return _?[2]:(Oe.context.orderNumber++,t.clientGameTime,h=d(t,["clientGameTime"]),O=l(l({},h),{stateHash:pe&&T?T.stateHash:void 0,orderNumber:Oe.context.orderNumber,serverGameTime:u,logicTick:f}),[4,w(e,O)]);case 14:return v.sent(),[2]}}))}))}function ae(e,r,t,n){var o=n.serverPreprocessingDurationInMs;return f(this,void 0,void 0,(function(){var n,a,i,s;return v(this,(function(c){switch(c.label){case 0:return t.sessionId!==Oe.context.sessionId?(_e.warn(e,"GAME_SESSION_ID_MISMATCH",{contextSessionId:Oe.context.sessionId,actionSessionId:t.sessionId}),[2]):"number"!=typeof t.randomSeed||"number"!=typeof t.actionCount?(_e.warn(e,"ACTION_NO_SEED_OR_ACTION_COUNT"),[2]):(u=t.params,n=D(u,30),a=F(),i=Z(a),s=t.expectedLogicTick,n.underLimit?me.update?[3,2]:[4,ee(e,r,t)]:[2,J(e,i,"ACTION_PARAMS_SIZE_OVER_LIMIT",void 0,{size:n.size,action:t.action})]);case 1:case 3:return c.sent(),[2];case 2:return C&&function(e,r,t){var n=e.expectedLogicTick,o=e.logicTick,a=e.msPerTick,i=e.serverGameTime,s=e.serverPreprocessingDurationInMs,c=i-s,u=a*n;if(n===o);else if(n>o)u-i>100&&r.info(t,"WRONG_TICK_CLIENT_AHEAD",{logicTick:o,expectedLogicTick:n,diff:u-i});else{var l=!1;s>10&&(l=!0,r.info(t,"WRONG_TICK_SERVER_SLOW",{logicTick:o,expectedLogicTick:n,serverReceivedTime:c,serverPreprocessingDurationInMs:s})),c>O(n+1,a)-10&&(l=!0,r.info(t,"WRONG_TICK_MSG_ARRIVED_LATE",{logicTick:o,expectedLogicTick:n,serverReceivedTime:c,serverPreprocessingDurationInMs:s})),l||r.info(t,"WRONG_TICK_UNEXPECTED_REASON",{logicTick:o,expectedLogicTick:n,serverPreprocessingDurationInMs:s})}}({expectedLogicTick:s,logicTick:i,serverPreprocessingDurationInMs:o,msPerTick:Te,serverGameTime:a},_e,e),s>i?(fe.push({gameToServerAction:t,userId:r}),[2]):[4,ee(e,r,t)]}var u}))}))}function ie(e,r,t,n){return f(this,void 0,void 0,(function(){return v(this,(function(o){return[2,ne.sendMsg(e,r,(j(t)?De:Me).encodeServerToGame({event:"latencyEstimate",measureLatencyStart:n.measureLatencyStart,serverGameTime:F()},!1))]}))}))}var se,ce,ue,le,de,fe,ve,pe,me,ge,Ee,ye,Se,Te,_e,Ie,he,Oe,Ae,be,Pe,Me,De,Re,Ne,Ce,Ge,Le,we,xe,ke,Ue,je,Ve,He,Fe=this;return v(this,(function(T){switch(T.label){case 0:if(!i&&!s)throw new Error("Either sessionId or initialServerData has to be provided");if(se=null!==(r=ne.getSeedForPlayerId)&&void 0!==r?r:function(){return Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)},ue=0,le=0,de=0,fe=[],ve=!1,pe=R||!!ne.onTimelineEntry,me=oe.getConfig(),ge=Y&&me.persistPlayerData,Ee=ne.getUsers(),ye=E(Ee),Se=[],_=me.updatesPerSecond,Te=Math.round(1e3/_),Object.keys(ye).length<me.minPlayers)throw new Error("GameServer cannot start as there is not enough players");if(Object.keys(ye).length>me.maxPlayers)throw new Error("GameServer cannot start due to too many players (some should be spectators and not in players object)");if(!c)throw new Error("GameServer cannot start without a serverSeed option");return _e=x(re),Ie=function(e){return Me=q({sdkProtocolVersion:2,gameId:o,sessionId:e,dictionary:be,logger:Ae}),De=q({sdkProtocolVersion:te,gameId:o,sessionId:e,dictionary:be,logger:Ae}),{context:{gameOver:null,orderNumber:1,sessionId:e,gameId:o},random:{},gameTime:0,updateCount:0}},Ae={onSessionMismatch:function(e,r,t){t&&_e.warn(t,"GAME_SESSION_ID_MISMATCH",{stateSessionId:Oe.context.sessionId,decoderSessionId:r,contextSessionId:i,actionSessionId:e})}},be=g([],m(U),!1),[4,oe.getActionNames(t)];case 1:return Pe=T.sent(),be.push.apply(be,g([],m(Pe.filter((function(e){return!be.includes(e)}))),!1)),be.sort((function(e,r){return r.length-e.length})),s?(he=s.game,Oe=function(e){return e.game,d(e,["game"])}(s),Me=q({sdkProtocolVersion:2,gameId:o,sessionId:Oe.context.sessionId,dictionary:be,logger:Ae}),De=q({sdkProtocolVersion:te,gameId:o,sessionId:Oe.context.sessionId,dictionary:be,logger:Ae}),[4,oe.rehydrate(t,a,s.game)]):[3,3];case 2:return T.sent(),[3,6];case 3:return T.trys.push([3,5,,6]),Re=me.persistPlayerData?Object.entries(u).reduce((function(e,r){var t,n=m(r,2),o=n[0],a=n[1],i=Ee[Number(o)].playerId;if(!i)throw new Error("PERSISTED_USER_PROVIDED_FOR_NON_PLAYER");return l(l({},e),((t={})[i]=a,t))}),{}):null,[4,B(oe.runSetup(t,{roomId:a,logicContext:{randomSeed:I(c,0),logicTick:0,msPerTick:Te},playerIds:M(Object.keys(ye)),calculateStateHash:pe,persistedPlayers:Re}))];case 4:return Ne=T.sent(),Ce=Ne.stateHash,Ge=Ne.gameState,he=Ge,Oe=Ie(i),n(t,{type:"START",serverSeed:c,initialPlayers:ye,logicTick:0,stateHash:Ce,persisted:Re}),[3,6];case 5:throw(Le=T.sent()).message.startsWith("[GAMES_SDK]")?(we=X(void 0,Le,"SETUP_FAILED"),_e.error(t,we,Le.extraLoggingData),"devUI"!==re?Le:new Error("Setup function failed")):(_e.error(t,"SETUP_FAILED",Le.extraLoggingData),Le);case 6:if(xe=s&&"gameTime"in s?s.gameTime:0,ke=A(),me.update){if(Ue=F(),je=h(Ue,Te),Math.abs(Oe.updateCount-je)>1)throw new Error("Update loop is out of sync with gameTime after redeployment. Logic Tick: ".concat(je,", updateCount: ").concat(Oe.updateCount));Oe.updateCount!==je?ce=setTimeout(ne.queueUpdateLoop,0,{logicTick:je}):(Ve=b(Ue,h(Ue,Te)+1,Te),ce=setTimeout(ne.queueUpdateLoop,Ve,{logicTick:je+1}))}return H&&(G(t,he),he=void 0),He={onMsg:function(e,r,t,n){var a=n.serverPreprocessingDurationInMs;return f(Fe,void 0,void 0,(function(){var n,i,s,c,u,l,d;return v(this,(function(f){switch(f.label){case 0:if(!P(t))return[2,J(e,Z(F()),"SERVER_RECEIVED_MESSAGE_TOO_BIG",void 0,{msgSize:2*t.length,limit:1048576})];n=ne.getUsers(),i=n[r];try{s=(j(i)?De:Me).decodeGameToServer(t,e)}catch(r){return _e.warn(e,"CLIENT_MESSAGE_DECODE_FAILED",{contextSessionId:Oe.context.sessionId,msg:t,err:r,compressionDictionary:be}),[2,Promise.resolve()]}return(c=s)?(k&&(u="type"in c?c.type:"gameToServerAction",_e.info(e,"GAME_TO_SERVER_MSG_SIZE",{event:u,messageLength:t.length})),l="type"in c&&"MEASURE_LATENCY"===c.type,L&&!l&&_e.info(e,"GAME_TO_SERVER_MSG",{gameToServerMsg:c}),l?[2,ie(e,r,i,c)]:"type"in c&&"REQUEST_STATE_SYNC"===c.type?null!==c.gameId&&c.gameId!==o?[2]:[4,S(e)]:[3,2]):[2,Promise.resolve()];case 1:return d=f.sent(),[2,K(e,"error"in d?{}:d.data.gameState,r,!1,c.measureLatencyStart)];case 2:return"type"in c&&"DEBUG_TIMELINE"===c.type?[2,(c.data,void r.toString())]:(ie(e,r,i,c),[2,ae(e,r,c,{serverPreprocessingDurationInMs:a})])}}))}))},onUpdateLoop:function(e,r){return f(Fe,void 0,void 0,(function(){var t,n,o,i,s,u,l,d,f,g,T,_,h,O,A,P,D,R,N;return v(this,(function(v){switch(v.label){case 0:if(ve||Oe.context.gameOver)return ce=void 0,[2];t=I(c,r.logicTick,"update-"),n=void 0,o=void 0,v.label=1;case 1:return v.trys.push([1,3,,4]),[4,B(oe.runUpdate(e,{roomId:a,logicContext:{randomSeed:t,logicTick:r.logicTick,msPerTick:Te},updateContext:{allPlayerIds:M(Object.keys(E(ne.getUsers())))}}))];case 2:return n=v.sent(),[3,4];case 3:return i=v.sent(),o=i,[3,4];case 4:return!(o||!n||!("data"in n))&&n.data?[3,6]:[4,J(e,r.logicTick,X(n,o,"SERVER_UPDATE_LOOP_FAILED"),o,(null==o?void 0:o.extraLoggingData)||void 0)];case 5:return v.sent(),[2];case 6:return Oe.updateCount++,de++,(s=n&&"data"in n&&n.data.gameContext.gameOver)?[4,y(e,r.logicTick,n.data.gameContext.gameOver)]:[3,8];case 7:s=!v.sent(),v.label=8;case 8:return s?[2]:Oe.context.gameOver?[4,S(e)]:[3,10];case 9:return"error"in(u=v.sent())||(G(e,u.data.gameState,!0),ce=void 0),[2];case 10:return l=F(),(d=l-r.logicTick*Te)<-1?[2,J(e,Oe.updateCount,"SERVER_UPDATE_LOOP_FASTER_THAN_GAME_TIME",void 0,{msPassedSinceTheStartOfLogicTick:d,serverGameTime:l,logicTick:r.logicTick,msPerTick:Te})]:de>=$?(f={event:"gameTimeUpdate",orderNumber:Oe.context.orderNumber,serverGameTime:l,params:{gameContext:Oe.context},logicTick:Oe.updateCount},[4,w(e,f)]):[3,12];case 11:v.sent(),v.label=12;case 12:if(g=r.logicTick+1,l-Te*g>z)return[2,J(e,Oe.updateCount,"UPDATE_LOOP_BEHIND_GAME_TIME")];v.label=13;case 13:v.trys.push([13,18,19,20]),T=p(fe.entries()),_=T.next(),v.label=14;case 14:return _.done?[3,17]:(h=m(_.value,2),O=h[0],null===(A=h[1])||A.gameToServerAction.expectedLogicTick!==r.logicTick?[3,16]:[4,ee(e,A.userId,A.gameToServerAction)]);case 15:v.sent(),fe[O]=null,v.label=16;case 16:return _=T.next(),[3,14];case 17:return[3,20];case 18:return P=v.sent(),R={error:P},[3,20];case 19:try{_&&!_.done&&(N=T.return)&&N.call(T)}finally{if(R)throw R.error}return[7];case 20:return fe=fe.filter((function(e){return null!==e})),D=b(F(),g,Te),ce=setTimeout(ne.queueUpdateLoop,D,{logicTick:g}),[2]}}))}))},onPlayerJoined:function(e,r,t){return f(Fe,void 0,void 0,(function(){var o,i,s,u,d,f,p,m,g,S;return v(this,(function(v){switch(v.label){case 0:if(Object.keys(E(ne.getUsers())).length>me.maxPlayers)return[2,J(e,Z(F()),"SERVER_FULL")];if(!me.eventCallbacks.playerJoined)return[2,J(e,Z(F()),"ON_PLAYER_JOINED_CALLBACK_MISSING")];ue++,o=I(c,ue),i=E(ne.getUsers()),s=F(),u=Z(s),d=void 0,f=void 0,v.label=1;case 1:return v.trys.push([1,3,,4]),[4,B(oe.runPlayerJoinedEvent(e,{roomId:a,logicContext:{randomSeed:o,msPerTick:Te,logicTick:u},playerId:r,eventContext:{allPlayerIds:M(Object.keys(i))},persistedPlayerState:me.persistPlayerData?t:null,calculateStateHash:pe}))];case 2:return d=v.sent(),[3,4];case 3:return p=v.sent(),f=p,[3,4];case 4:return m=!(f||!d||!("data"in d))&&d.data,n(e,l({type:"PLAYER_JOINED",player:i[r],persisted:me.persistPlayerData?t:null,logicTick:u},m?{success:!0,stateHash:m.stateHash}:{success:!1})),m?[3,6]:[4,J(e,u,X(d,f,"PLAYER_JOINED_FAILED"),f,(null==f?void 0:f.extraLoggingData)||void 0)];case 5:return v.sent(),[2];case 6:return(g=m.gameContext.gameOver)?[4,y(e,u,m.gameContext.gameOver)]:[3,8];case 7:g=!v.sent(),v.label=8;case 8:return g?[2]:(Oe.context.orderNumber++,S={event:"playerJoined",params:{playerId:r,players:i,gameContext:Oe.context,randomSeed:o,stateHash:pe?m.stateHash:void 0,persistedPlayerState:me.persistPlayerData?t:void 0},orderNumber:Oe.context.orderNumber,serverGameTime:s,logicTick:u},[4,w(e,S)]);case 9:return v.sent(),[2]}}))}))},onPlayerLeft:function(r,t){return f(Fe,void 0,void 0,(function(){var o,i,s,u,d,f,p,m,g,S,T,_,h,O;return v(this,(function(v){switch(v.label){case 0:return Oe.context.gameOver?(_e.info(r,"PLAYER_LEFT_AFTER_GAME_OVER"),[2,null]):(o=ne.getUsers(),i=F(),s=Z(i),0!==Object.keys(o).length?[3,2]:[4,e(r,s,"minPlayers")]);case 1:return u=v.sent(),ge?u&&1===Object.keys(u).length?[2,u[t]]:(_e.error(r,"PLAYER_LEFT_NO_USERS_INCORRECT_PERSISTED_PLAYERS",{players:null===u?"NO PLAYERS":Object.keys(u)}),[2,null]):[2,null];case 2:if(d=E(o),Se.push(t),ue++,f=I(c,ue),p=!1,m=Object.keys(d).length>=me.minPlayers,g=me.eventCallbacks.playerLeft,!m||!g)return[3,8];S=void 0,T=void 0,v.label=3;case 3:return v.trys.push([3,5,,6]),[4,B(oe.runPlayerLeftEvent(r,{roomId:a,logicContext:{randomSeed:f,msPerTick:Te,logicTick:s},playerId:t,eventContext:{allPlayerIds:M(Object.keys(d))},calculateStateHash:pe}))];case 4:return S=v.sent(),[3,6];case 5:return _=v.sent(),T=_,[3,6];case 6:return p=!(T||!S||!("data"in S))&&S.data,n(r,l({type:"PLAYER_LEFT",playerId:t,logicTick:s},p?{success:!0,stateHash:p.stateHash}:{success:!1})),p?[3,8]:[4,J(r,s,X(S,T,"PLAYER_LEFT_FAILED"),T,(null==T?void 0:T.extraLoggingData)||void 0)];case 7:return v.sent(),[2,null];case 8:return!(h=!!p&&"gameContext"in p&&p.gameContext.gameOver)&&g&&m?[3,10]:[4,y(r,s,h||(g?{reason:"minPlayers",players:d}:{reason:"playerLeft",players:d}))];case 9:if(!v.sent())return[2,null];v.label=10;case 10:return Oe.context.orderNumber++,O={event:"playerLeft",params:{playerId:t,players:d,randomSeed:f,gameContext:Oe.context,stateHash:pe&&p&&p.stateHash?p.stateHash:void 0},orderNumber:Oe.context.orderNumber,serverGameTime:i,logicTick:s},[4,w(r,O)];case 11:return v.sent(),[2,ge&&p&&"persistedPlayers"in p&&p.persistedPlayers?p.persistedPlayers[t]:null]}}))}))},getDataForSerialization:function(e){return f(Fe,void 0,void 0,(function(){var r;return v(this,(function(t){switch(t.label){case 0:return[4,S(e)];case 1:if("error"in(r=t.sent()))throw new Error(r.error);return[2,l(l({},Oe),{gameTime:F(),game:r.data.gameState})]}}))}))},getPersistedUsers:function(e,r){return f(Fe,void 0,void 0,(function(){var t,n,o;return v(this,(function(a){switch(a.label){case 0:if(!ge)throw new Error("[GAMES_SDK][GAME_DOES_NOT_USE_PERSIST]");return t=ne.getUsers(),n=r?r.map((function(e){return t[e].playerId})):Object.keys(E(t)),[4,N(e,n)];case 1:if("error"in(o=a.sent()))throw new Error(o.error);return[2,Object.keys(o).reduce((function(e,r){return e[Object.values(t).find((function(e){return e.playerId===r})).userId]=o[r],e}),{})]}}))}))},getConfig:function(){return me},getSessionId:function(){return Oe.context.sessionId},getGameId:function(){return Oe.context.gameId},cleanup:function(r){return f(Fe,void 0,void 0,(function(){var t,n;return v(this,(function(o){switch(o.label){case 0:return ce&&(clearTimeout(ce),ce=void 0),t=null,ve?[3,2]:[4,e(r,Z(F()),"stop")];case 1:n=o.sent(),t=Q(n,ne,_e,r),o.label=2;case 2:return[4,oe.cleanup(r,a)];case 3:return o.sent(),[2,t]}}))}))},isGameOver:function(){return!!Oe.context.gameOver},getCodec:function(){return De}},[2,He]}var _}))}))},exports.createSdkForLogicRunner=function(e){globalThis.Math.__SDK_PRECISION_SET__||(re.forEach((function(e){var r,t;globalThis.Math[e]=(r=globalThis.Math,t=globalThis.Math[e],function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return r.fround(t.apply(r,e))})})),globalThis.Math.__SDK_PRECISION_SET__=!0);var r={setup:void 0,actions:void 0,events:void 0,logicContext:{msPerTick:0,logicTick:0,randomSeed:0},gameOverContext:null,initLogic:function(o){var a,i,s;if(!o)throw new Error("initParams are required");"runtime"!==e&&function(e){if(e.minPlayers<1)throw new Error("minPlayers cannot be lower than 1");if(e.maxPlayers>6)throw new Error("maxPlayers cannot be greater than ".concat(6));if(e.maxPlayers<e.minPlayers)throw new Error("minPlayers cannot be greater than maxPlayers");if(void 0!==e.updatesPerSecond&&("number"!=typeof e.updatesPerSecond||e.updatesPerSecond<1||e.updatesPerSecond>30||!Number.isInteger(e.updatesPerSecond)))throw new Error("updatesPerSecond must be either not defined or a number between 1 & ".concat(30))}(o),r.gameConfig={minPlayers:o.minPlayers,maxPlayers:o.maxPlayers,eventCallbacks:{playerJoined:!!(null===(a=o.events)||void 0===a?void 0:a.playerJoined),playerLeft:!!(null===(i=o.events)||void 0===i?void 0:i.playerLeft)},update:!!o.update,updatesPerSecond:o.updatesPerSecond||1,landscape:null!==(s=o.landscape)&&void 0!==s&&s,persistPlayerData:o.persistPlayerData||!1,reactive:void 0===o.reactive||o.reactive},r.setup=function(n){var a=n.roomId,i=n.logicContext,s=n.playerIds,c=n.calculateStateHash,u=n.persistedPlayers;return t(i,(function(){var t,n,i,l,d=(null===(t=r.gameConfig)||void 0===t?void 0:t.persistPlayerData)&&null!==u;d?(i={persisted:u},s.forEach((function(e){i.persisted[e]||(i.persisted[e]={})}))):i={};var f=ce(i,(function(e){var r;l=null!==(r=o.setup(s,d?{game:e}:void 0))&&void 0!==r?r:{}}),r.gameConfig.reactive);if("runtime"!==e){if(l.persisted)throw Z("SETUP_PERSISTED_KEY_NOT_ALLOWED");(null===(n=r.gameConfig)||void 0===n?void 0:n.persistPlayerData)&&f.persisted!==i.persisted&&ge(f,s)}var v=ce(l||{},(function(e){var t;(null===(t=r.gameConfig)||void 0===t?void 0:t.persistPlayerData)&&(e.persisted=f.persisted)}),r.gameConfig.reactive);if(oe(a,v),r.gameOverContext)throw Z("SETUP_GAME_OVER_NOT_ALLOWED");return{gameState:v,stateHash:c?pe(v):void 0}}))},r.actions=Object.fromEntries(Object.entries(o.actions||{}).map((function(e){var t=m(e,2),o=t[0],a=t[1];return[o,function(e){var t,o=e.roomId,i=e.logicContext,s=e.params,c=e.actionContext,u=e.calculateStateHash;return n(o,i,(function(e){a(s,l(l({},c),{game:e}))}),c.allPlayerIds,u,!0,(null===(t=r.gameConfig)||void 0===t?void 0:t.persistPlayerData)||!1)}]}))),r.events={playerJoined:function(e){var t,a,i=e.roomId,s=e.logicContext,c=e.playerId,u=e.persistedPlayerState,d=e.eventContext,f=e.calculateStateHash,v=ne(i);(null===(t=r.gameConfig)||void 0===t?void 0:t.persistPlayerData)&&null!==u&&oe(i,ce(v,(function(e){e.persisted[c]=u}),r.gameConfig.reactive));return n(i,s,(function(e){var r,t;null===(t=null===(r=o.events)||void 0===r?void 0:r.playerJoined)||void 0===t||t.call(r,c,l(l({},d),{game:e}))}),d.allPlayerIds,f,!1,(null===(a=r.gameConfig)||void 0===a?void 0:a.persistPlayerData)||!1)},playerLeft:function(e){var t,a,i,s,c=e.roomId,u=e.logicContext,d=e.playerId,f=e.eventContext,v=e.calculateStateHash,p=ne(c);(null===(a=r.gameConfig)||void 0===a?void 0:a.persistPlayerData)&&oe(c,ce(p,(function(e){delete e.persisted[d]}),r.gameConfig.reactive));var m=n(c,u,(function(e){var r,t;null===(t=null===(r=o.events)||void 0===r?void 0:r.playerLeft)||void 0===t||t.call(r,d,l(l({},f),{game:e}))}),f.allPlayerIds,v,!1,(null===(i=r.gameConfig)||void 0===i?void 0:i.persistPlayerData)||!1);return"data"in m?{data:l(l({},m.data),{persistedPlayers:(null===(s=r.gameConfig)||void 0===s?void 0:s.persistPlayerData)?(t={},t[d]=p.persisted[d],t):null})}:m}},o.update?r.update=function(e){var t,a=e.roomId,i=e.logicContext,s=e.updateContext;return n(a,i,(function(e){var r;null===(r=o.update)||void 0===r||r.call(o,l(l({},s),{game:e}))}),s.allPlayerIds,!1,!1,(null===(t=r.gameConfig)||void 0===t?void 0:t.persistPlayerData)||!1)}:delete r.update},invalidAction:function(){return(e=new Error("".concat("Dusk",".invalidAction() was called"))).name=ee,e;var e},gameOver:function(e){r.gameOverContext={reason:"gameEnded",options:$(e),players:{}}},gameTime:function(){var e,t;return O(null!==(e=r.logicContext.logicTick)&&void 0!==e?e:0,null!==(t=r.logicContext.msPerTick)&&void 0!==t?t:0)},gameTimeInSeconds:function(){return e=r.gameTime(),Math.floor(e/1e3);var e},runAction:function(e){for(var t,n=[],o=1;o<arguments.length;o++)n[o-1]=arguments[o];return(t=r.actions)[e].apply(t,g([],m(n),!1))},runPlayerJoinedEvent:function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return(e=r.events).playerJoined.apply(e,g([],m(t),!1))},runPlayerLeftEvent:function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return(e=r.events).playerLeft.apply(e,g([],m(t),!1))},rehydrate:function(e,r){oe(e,r)},getActionNames:function(){return r.actions?Object.keys(r.actions):[]},getGameState:function(e,r){try{var t=ne(e);return{data:{gameState:ne(e),stateHash:r?pe(t):void 0}}}catch(e){if("[GAMES_SDK][ROOM_GAME_STATE_MISSING]"===e.message)return{error:e.message};throw e}},cleanup:function(e){ae(e)},getPersistedData:function(e,t){var n;if(!(null===(n=r.gameConfig)||void 0===n?void 0:n.persistPlayerData))throw Z("PERSISTED_STATE_NOT_ENABLED");var o=r.getGameState(e,!1);if("error"in o)return o;var a=o.data.gameState.persisted;if(!t)return{data:{persistedPlayers:a}};var i={};return t.forEach((function(e){i[e]=a[e]})),{data:{persistedPlayers:i}}}};function t(e,t){return r.gameOverContext=null,r.logicContext=e,ve(r.logicContext.randomSeed,t)}function n(n,o,a,i,s,c,u){return t(o,(function(){try{var t=ne(n),o=ce(t,a,r.gameConfig.reactive);if("runtime"!==e){if(!u&&o.persisted)throw Z("PERSISTED_STATE_USED_WITHOUT_FLAG");t.persisted!==o.persisted&&ge(o,i)}return oe(n,o),{data:{gameContext:{gameOver:r.gameOverContext},stateHash:s?pe(o):void 0}}}catch(e){if(c&&(function(e){return"object"==typeof e&&null!==e&&"name"in e}(l=e)&&("RUNE_INVALID_ACTION"===l.name||"DUSK_INVALID_ACTION"===l.name)))return{data:!1};if("[GAMES_SDK][ROOM_GAME_STATE_MISSING]"===e.message)return{error:e.message};throw ae(n),e}var l}))}return r},exports.generateId=function(e){void 0===e&&(e=12);for(var r="",t=0;t<e;t++)r+=y.charAt(Math.floor(Math.random()*S));return r},exports.isNewUserSpectator=function(e,r,t){return Object.keys(E(e)).length>=r.maxPlayers||!r.eventCallbacks.playerJoined||t};
